<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crystalline | 3D Personality Engine</title>
    <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg: #e0e5ec;
            --primary: #5b8def;
            --secondary: #8b7ff4;
            --text: #2d3436;
            --mute: #6c7983;
            --shadow-light: #ffffff;
            --shadow-dark: #a3b1c6;
            --font: 'Segoe UI', Roboto, sans-serif;
        }
        body.dark {
            --bg: #2d3748;
            --primary: #4facfe;
            --secondary: #a78bfa;
            --text: #e2e8f0;
            --mute: #94a3b8;
            --shadow-light: #374151;
            --shadow-dark: #1a202c;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; outline: none; }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { 
            background: var(--primary); 
            border-radius: 10px;
            box-shadow: inset 2px 2px 5px var(--shadow-dark), inset -2px -2px 5px var(--shadow-light);
        }
        
        body { 
            background: var(--bg); 
            color: var(--text); 
            font-family: var(--font); 
            overflow: hidden; 
            height: 100vh; 
            width: 100vw; 
            transition: background 0.3s; 
        }
        
        #canvas-webgl { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; opacity: 0.4; }
        
        .ui-layer { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 10; 
            pointer-events: none; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
        }
        
        .glass-panel { 
            pointer-events: auto; 
            background: var(--bg);
            border-radius: 30px; 
            padding: 50px; 
            width: 90%; 
            max-width: 750px; 
            max-height: 85vh; 
            overflow-y: auto; 
            text-align: center; 
            box-shadow: 
                12px 12px 24px var(--shadow-dark),
                -12px -12px 24px var(--shadow-light);
            display: none; 
            opacity: 0; 
            transform: translateY(30px); 
            transition: 0.5s ease; 
        }
        .glass-panel.active { display: block; opacity: 1; transform: translateY(0); }
        .glass-panel.exit { display: block; opacity: 0; transform: translateY(-30px); pointer-events: none; }
        
        h1 { 
            font-size: 3.5rem; 
            font-weight: 800; 
            background: linear-gradient(135deg, var(--primary), var(--secondary)); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        h2 { 
            font-size: 1.3rem; 
            color: var(--primary); 
            margin-bottom: 25px; 
            font-weight: 600; 
        }
        
        h3 { 
            font-size: 1.2rem; 
            color: var(--text); 
            margin: 30px 0 15px 0; 
            font-weight: 700;
        }
        
        p { 
            line-height: 1.7; 
            color: var(--mute); 
            margin-bottom: 20px; 
            font-size: 1rem; 
        }
        
        .btn { 
            background: var(--bg);
            border: none; 
            padding: 18px 45px; 
            border-radius: 50px; 
            color: var(--primary); 
            font-weight: bold; 
            text-transform: uppercase; 
            cursor: pointer; 
            transition: all 0.3s ease;
            box-shadow: 
                8px 8px 16px var(--shadow-dark),
                -8px -8px 16px var(--shadow-light);
            margin-top: 15px;
            position: relative;
            overflow: hidden;
        }
        .btn:hover { 
            box-shadow: 
                inset 4px 4px 8px var(--shadow-dark),
                inset -4px -4px 8px var(--shadow-light);
        }
        .btn:active {
            box-shadow: 
                inset 6px 6px 12px var(--shadow-dark),
                inset -6px -6px 12px var(--shadow-light);
        }

        .progress-container {
            position: fixed;
            top: 50%;
            left: 40px;
            transform: translateY(-50%);
            z-index: 20;
            display: none;
        }
        .circular-progress {
            position: relative;
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: var(--bg);
            box-shadow: 
                10px 10px 20px var(--shadow-dark),
                -10px -10px 20px var(--shadow-light);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .progress-ring {
            transform: rotate(-90deg);
            position: absolute;
        }
        .progress-ring-circle {
            stroke: var(--shadow-dark);
            fill: transparent;
            stroke-width: 6;
            opacity: 0.3;
        }
        .progress-ring-fill {
            stroke: url(#gradient);
            fill: transparent;
            stroke-width: 8;
            stroke-linecap: round;
            stroke-dasharray: 314.159;
            stroke-dashoffset: 314.159;
            transition: stroke-dashoffset 0.5s ease;
            filter: drop-shadow(0 0 10px var(--primary));
        }
        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.6rem;
            font-weight: bold;
            color: var(--text);
            z-index: 2;
        }
        .progress-label {
            text-align: center;
            margin-top: 15px;
            font-size: 0.9rem;
            color: var(--mute);
            font-weight: 600;
            letter-spacing: 1px;
        }

        .options-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
            margin-top: 30px; 
        }
        .option-card { 
            background: var(--bg);
            padding: 25px; 
            border-radius: 20px; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 12px;
            box-shadow: 
                8px 8px 16px var(--shadow-dark),
                -8px -8px 16px var(--shadow-light);
        }
        .option-card:hover { 
            box-shadow: 
                12px 12px 24px var(--shadow-dark),
                -12px -12px 24px var(--shadow-light);
            transform: translateY(-3px);
        }
        .option-card:active {
            box-shadow: 
                inset 4px 4px 8px var(--shadow-dark),
                inset -4px -4px 8px var(--shadow-light);
            transform: translateY(0);
        }
        .option-card i { 
            font-size: 2.2rem; 
            color: var(--primary);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        .option-text { 
            font-size: 0.95rem; 
            line-height: 1.5; 
            color: var(--text);
            font-weight: 500;
        }

        .top-dock { 
            position: fixed; 
            top: 25px; 
            right: 25px; 
            z-index: 100; 
            display: flex; 
            gap: 15px; 
            pointer-events: auto; 
        }
        .dock-btn { 
            width: 50px; 
            height: 50px; 
            border-radius: 50%; 
            background: var(--bg);
            color: var(--text); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            transition: all 0.3s ease;
            box-shadow: 
                6px 6px 12px var(--shadow-dark),
                -6px -6px 12px var(--shadow-light);
        }
        .dock-btn:hover { 
            color: var(--primary);
            box-shadow: 
                8px 8px 16px var(--shadow-dark),
                -8px -8px 16px var(--shadow-light);
        }
        .dock-btn:active {
            box-shadow: 
                inset 4px 4px 8px var(--shadow-dark),
                inset -4px -4px 8px var(--shadow-light);
        }
        
        .settings-panel { 
            position: fixed; 
            top: 90px; 
            right: 25px; 
            width: 280px; 
            background: var(--bg);
            border-radius: 20px; 
            padding: 25px; 
            transform: translateX(330px); 
            transition: 0.4s ease; 
            z-index: 99; 
            pointer-events: auto;
            box-shadow: 
                10px 10px 20px var(--shadow-dark),
                -10px -10px 20px var(--shadow-light);
        }
        .settings-panel.open { transform: translateX(0); }
        
        .cookie-modal { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            backdrop-filter: blur(10px); 
            z-index: 999; 
            display: none; 
            justify-content: center; 
            align-items: center; 
            pointer-events: auto; 
        }
        .cookie-modal.show { display: flex; }
        .cookie-box { 
            background: var(--bg);
            padding: 50px; 
            border-radius: 30px; 
            max-width: 500px; 
            text-align: center;
            box-shadow: 
                15px 15px 30px var(--shadow-dark),
                -15px -15px 30px var(--shadow-light);
        }
        
        .stats-row { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 20px; 
            margin-top: 35px; 
        }
        .stat-col { 
            background: var(--bg);
            border-radius: 20px; 
            padding: 25px; 
            position: relative; 
            overflow: visible;
            min-height: 180px; 
            display: flex; 
            flex-direction: column; 
            align-items: center;
            box-shadow: 
                inset 6px 6px 12px var(--shadow-dark),
                inset -6px -6px 12px var(--shadow-light);
        }
        .stat-icon { 
            font-size: 2.2rem; 
            color: var(--primary); 
            margin-bottom: 15px; 
            z-index: 2;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.1));
        }
        .stat-gauge-container { 
            width: 100%; 
            height: 90px; 
            background: var(--bg);
            border-radius: 15px; 
            position: relative; 
            overflow: hidden;
            box-shadow: 
                inset 4px 4px 8px var(--shadow-dark),
                inset -4px -4px 8px var(--shadow-light);
        }
        .stat-fill { 
            position: absolute; 
            bottom: 0; 
            width: 100%; 
            background: linear-gradient(to top, var(--secondary), var(--primary)); 
            height: 0%; 
            transition: height 1.2s cubic-bezier(0.4, 0, 0.2, 1); 
            box-shadow: 0 -4px 16px rgba(91, 141, 239, 0.5);
            border-radius: 15px 15px 0 0;
        }
        .stat-percent { 
            margin-top: 12px; 
            font-weight: bold; 
            color: var(--primary); 
            font-size: 1rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        
        .detail-grid { 
            display: grid; 
            grid-template-columns: 1fr; 
            gap: 15px; 
            text-align: left; 
            margin-top: 25px; 
        }
        .detail-item { 
            padding: 18px; 
            background: var(--bg);
            border-radius: 15px;
            font-size: 0.95rem; 
            color: var(--text);
            box-shadow: 
                6px 6px 12px var(--shadow-dark),
                -6px -6px 12px var(--shadow-light);
            border-left: 4px solid var(--primary);
        }
        .detail-label { 
            font-weight: bold; 
            color: var(--primary); 
            margin-right: 8px; 
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
    </style>
</head>
<body>
    <div id="canvas-webgl"></div>

    <div class="cookie-modal" id="cookie-modal">
        <div class="cookie-box">
            <i class="fa-solid fa-cookie-bite" style="font-size: 3rem; color: var(--primary); margin-bottom: 20px;"></i>
            <h2 style="color:var(--text); margin-bottom:10px;">User Consent</h2>
            <p style="color:var(--mute); margin-bottom:20px;">We have MIT licenses. By pressing the Accept & Continue button, you agree to our terms. Copyright (c) 2026 Juwon Jung </p>
            <button class="btn" onclick="acceptCookies()">Accept & Continue</button>
        </div>
    </div>

    <div class="top-dock">
        <div class="dock-btn" onclick="toggleTheme()"><i class="fa-solid fa-circle-half-stroke"></i></div>
        <div class="dock-btn" onclick="toggleSettings()"><i class="fa-solid fa-sliders"></i></div>
    </div>

    <div class="settings-panel" id="settings-panel">
        <h3 style="color:var(--text); margin-bottom:20px;">Settings</h3>
        <button class="btn" style="width:100%; padding:12px; font-size:0.9rem; color: #e74c3c; margin-bottom: 10px;" onclick="resetData()">Reset Data</button>
        <button class="btn" style="width:100%; padding:12px; font-size:0.9rem; color: var(--text);" onclick="toggleSettings()">Close</button>
    </div>

    <div class="progress-container" id="progress-container">
        <div class="circular-progress">
            <svg class="progress-ring" width="140" height="140">
                <defs>
                    <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:var(--primary);stop-opacity:1" />
                        <stop offset="100%" style="stop-color:var(--secondary);stop-opacity:1" />
                    </linearGradient>
                </defs>
                <circle class="progress-ring-circle" cx="70" cy="70" r="50"></circle>
                <circle class="progress-ring-fill" id="progress-fill" cx="70" cy="70" r="50"></circle>
            </svg>
            <div class="progress-text" id="progress-percent">0%</div>
        </div>
        <div class="progress-label">PROGRESS</div>
    </div>

    <div class="ui-layer">
        <div id="screen-intro" class="glass-panel active">
            <i class="fa-solid fa-cube" style="font-size: 4rem; color: var(--primary); margin-bottom: 20px; animation: float 3s infinite ease-in-out;"></i>
            <h1>MBTITESTS - MBTI 테스트</h1>
            <h2>Test your personality type</h2>
            <p>A procedural evaluation of your neural archetypes through 16 situational constructs. This web renders your psychological profile in real-time.</p>
            <button class="btn" onclick="startQuiz()">Begin Testing</button>
        </div>

        <div id="screen-quiz" class="glass-panel">
            <h2 id="q-text" style="color: var(--text); font-weight: 700; font-size: 1.3rem;">Initializing...</h2>
            <div class="options-grid" id="q-options"></div>
        </div>

        <div id="screen-result" class="glass-panel">
            <i class="fa-solid fa-id-card" style="font-size: 3rem; color: var(--secondary); margin-bottom: 15px;"></i>
            <h1 id="res-code" style="font-size: 4rem; margin: 5px 0;">----</h1>
            <h2 id="res-name" style="color: var(--primary); font-weight: bold; margin-bottom:20px;">Processing...</h2>
            
            <p id="res-desc" style="font-style: italic; border-left: 2px solid var(--secondary); padding-left: 15px; text-align: left;">
                Calculating archetype description...
            </p>

            <div class="stats-row">
                <div class="stat-col">
                    <div class="stat-icon"><i class="fa-solid fa-brain"></i></div>
                    <div class="stat-gauge-container"><div class="stat-fill" id="bar-E"></div></div>
                    <div class="stat-percent" id="pct-E">0%</div>
                </div>
                <div class="stat-col">
                    <div class="stat-icon"><i class="fa-solid fa-bolt"></i></div>
                    <div class="stat-gauge-container"><div class="stat-fill" id="bar-N"></div></div>
                    <div class="stat-percent" id="pct-N">0%</div>
                </div>
                <div class="stat-col">
                    <div class="stat-icon"><i class="fa-solid fa-heart"></i></div>
                    <div class="stat-gauge-container"><div class="stat-fill" id="bar-T"></div></div>
                    <div class="stat-percent" id="pct-T">0%</div>
                </div>
                <div class="stat-col">
                    <div class="stat-icon"><i class="fa-solid fa-chess"></i></div>
                    <div class="stat-gauge-container"><div class="stat-fill" id="bar-J"></div></div>
                    <div class="stat-percent" id="pct-J">0%</div>
                </div>
            </div>

            <h3>Neural Breakdown</h3>
            <div class="detail-grid" id="detail-box"></div>

            <button class="btn" onclick="resetData()" style="margin-top: 30px;">Restart</button>
        </div>
    </div>

    <script>
        const DB_KEY = 'crystalline_light_v2';
        const COOKIE_KEY = 'crystalline_consent_v1';
        
        const questions = [
            { t: "After a chaotic week of deadlines and meetings, you finally have a free evening. You choose to:", d: 'EI', o: [{l: "Retreat to your sanctuary to recharge alone.", i: "fa-book-open-reader", v: -1}, {l: "Call friends to debrief over drinks.", i: "fa-champagne-glasses", v: 1}] },
            { t: "In a strategy meeting, you are the person who usually:", d: 'EI', o: [{l: "Absorbs information and speaks last.", i: "fa-ear-listen", v: -1}, {l: "Thinks out loud and drives the discussion.", i: "fa-microphone", v: 1}] },
            { t: "At a networking event, you prefer to:", d: 'EI', o: [{l: "Have deep conversations with a few people.", i: "fa-comments", v: -1}, {l: "Mingle and meet as many people as possible.", i: "fa-users", v: 1}] },
            { t: "When working on a group project, you feel energized by:", d: 'EI', o: [{l: "Working independently on your portion.", i: "fa-user", v: -1}, {l: "Brainstorming sessions with the team.", i: "fa-people-group", v: 1}] },
            
            { t: "When tasked with a new project, you are more excited by:", d: 'SN', o: [{l: "The visionary potential and abstract concepts.", i: "fa-rocket", v: -1}, {l: "The proven methods and tangible metrics.", i: "fa-chart-pie", v: 1}] },
            { t: "You are interpreting a complex film. You focus primarily on:", d: 'SN', o: [{l: "The metaphorical themes and hidden meanings.", i: "fa-masks-theater", v: -1}, {l: "The cinematography, acting, and set design.", i: "fa-video", v: 1}] },
            { t: "When learning a new skill, you prefer:", d: 'SN', o: [{l: "Understanding the underlying theory first.", i: "fa-lightbulb", v: -1}, {l: "Hands-on practice with concrete examples.", i: "fa-hand", v: 1}] },
            { t: "When describing your day, you typically:", d: 'SN', o: [{l: "Focus on the meaning and patterns you noticed.", i: "fa-brain", v: -1}, {l: "Recount specific events and details.", i: "fa-list", v: 1}] },
            
            { t: "A close friend made a mistake that impacts the group. You:", d: 'TF', o: [{l: "Console them first; feelings matter most.", i: "fa-hand-holding-heart", v: -1}, {l: "Analyze what went wrong to fix the process.", i: "fa-wrench", v: 1}] },
            { t: "You are judging a debate competition. The winner is the one who:", d: 'TF', o: [{l: "Navigated the topic with empathy and grace.", i: "fa-dove", v: -1}, {l: "Presented the most logical, irrefutable facts.", i: "fa-gavel", v: 1}] },
            { t: "When making an important decision, you prioritize:", d: 'TF', o: [{l: "How it will affect people's feelings and harmony.", i: "fa-heart", v: -1}, {l: "The most efficient and logical outcome.", i: "fa-calculator", v: 1}] },
            { t: "In a disagreement, you tend to:", d: 'TF', o: [{l: "Consider how everyone feels about the situation.", i: "fa-people-arrows", v: -1}, {l: "Focus on finding the objectively correct answer.", i: "fa-balance-scale", v: 1}] },

            { t: "You are packing for a two-week trip. Your suitcase is:", d: 'JP', o: [{l: "Packed last minute with random essentials.", i: "fa-person-walking-luggage", v: -1}, {l: "Organized with packing cubes and a checklist.", i: "fa-list-check", v: 1}] },
            { t: "Your workflow is best described as:", d: 'JP', o: [{l: "Bursts of energy fueled by pressure.", i: "fa-bolt", v: -1}, {l: "Steady, consistent progress toward the goal.", i: "fa-arrow-trend-up", v: 1}] },
            { t: "When planning a vacation, you prefer to:", d: 'JP', o: [{l: "Keep it flexible and spontaneous.", i: "fa-map", v: -1}, {l: "Create a detailed itinerary in advance.", i: "fa-calendar-days", v: 1}] },
            { t: "Your approach to deadlines is:", d: 'JP', o: [{l: "Work expands to fill the time available.", i: "fa-hourglass", v: -1}, {l: "Finish early to avoid last-minute stress.", i: "fa-clock", v: 1}] }
        ];

        const archetypes = { 
            "ISTJ":"The Logistician", "ISFJ":"The Defender", "INFJ":"The Advocate", "INTJ":"The Architect", 
            "ISTP":"The Virtuoso", "ISFP":"The Adventurer", "INFP":"The Mediator", "INTP":"The Logician", 
            "ESTP":"The Entrepreneur", "ESFP":"The Entertainer", "ENFP":"The Campaigner", "ENTP":"The Debater", 
            "ESTJ":"The Executive", "ESFJ":"The Consul", "ENFJ":"The Protagonist", "ENTJ":"The Commander" 
        };

        const descriptions = {
            "ISTJ": "Practical and fact-minded individuals, whose reliability cannot be doubted.",
            "ISFJ": "Very dedicated and warm protectors, always ready to defend their loved ones.",
            "INFJ": "Quiet and mystical, yet very inspiring and tireless idealists.",
            "INTJ": "Imaginative and strategic thinkers, with a plan for everything.",
            "ISTP": "Bold and practical experimenters, masters of all kinds of tools.",
            "ISFP": "Flexible and charming artists, always ready to explore and experience something new.",
            "INFP": "Poetic, kind and altruistic people, always eager to help a good cause.",
            "INTP": "Innovative inventors with an unquenchable thirst for knowledge.",
            "ESTP": "Smart, energetic and very perceptive people, who truly enjoy living on the edge.",
            "ESFP": "Spontaneous, energetic and enthusiastic people – life is never boring around them.",
            "ENFP": "Enthusiastic, creative and sociable free spirits, who can always find a reason to smile.",
            "ENTP": "Smart and curious thinkers who cannot resist an intellectual challenge.",
            "ESTJ": "Excellent administrators, unsurpassed at managing things – or people.",
            "ESFJ": "Extraordinarily caring, social and popular people, always eager to help.",
            "ENFJ": "Charismatic and inspiring leaders, able to mesmerize their listeners.",
            "ENTJ": "Bold, imaginative and strong-willed leaders, always finding a way – or making one."
        };

        let state = { q: 0, scores: { EI:0, SN:0, TF:0, JP:0 }, theme: 'light' };
        let scene, camera, renderer, crystal, particles;

        window.onload = () => {
            initThree();
            if(!localStorage.getItem(COOKIE_KEY)) document.getElementById('cookie-modal').classList.add('show');
            else loadState();
        };

        function initThree() {
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0xeef2f5, 0.02);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.z = 5;
            renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            document.getElementById('canvas-webgl').appendChild(renderer.domElement);
            
            const ambient = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambient);
            const l1 = new THREE.PointLight(0x00f2ff, 3, 50); l1.position.set(5, 5, 5); scene.add(l1);
            const l2 = new THREE.PointLight(0xbd00ff, 3, 50); l2.position.set(-5, -5, 5); scene.add(l2);

            const geo = new THREE.IcosahedronGeometry(1.6, 0);
            const mat = new THREE.MeshPhysicalMaterial({
                color: 0xffffff, metalness: 0, roughness: 0, transmission: 1, thickness: 1.5, ior: 1.5
            });
            crystal = new THREE.Mesh(geo, mat);
            const wire = new THREE.Mesh(new THREE.IcosahedronGeometry(1.62, 0), new THREE.MeshBasicMaterial({ color: 0x00f2ff, wireframe: true, transparent: true, opacity: 0.15 }));
            crystal.add(wire);
            scene.add(crystal);

            const sGeo = new THREE.BufferGeometry();
            const sCount = 1500;
            const pos = new Float32Array(sCount * 3);
            for(let i=0; i<sCount*3; i++) pos[i] = (Math.random()-0.5)*80;
            sGeo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
            particles = new THREE.Points(sGeo, new THREE.PointsMaterial({ size: 0.05, color: 0x000000 }));
            scene.add(particles);

            animate();
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth/window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
            document.addEventListener('mousemove', (e) => {
                if(crystal) {
                    crystal.rotation.x += (e.clientY - window.innerHeight/2)*0.00005;
                    crystal.rotation.y += (e.clientX - window.innerWidth/2)*0.00005;
                }
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            if(crystal) { crystal.rotation.x += 0.001; crystal.rotation.y += 0.002; }
            if(particles) particles.rotation.y -= 0.0002;
            renderer.render(scene, camera);
        }

        function acceptCookies() {
            localStorage.setItem(COOKIE_KEY, 'true');
            document.getElementById('cookie-modal').classList.remove('show');
            loadState();
        }

        function loadState() {
            const saved = localStorage.getItem(DB_KEY);
            if(saved) {
                try {
                    state = JSON.parse(saved);
                    if(!state.scores) throw new Error("Corrupt Data");
                    applyTheme(state.theme);
                    if(state.q >= questions.length) showResults();
                    else if(state.q > 0) resumeQuiz();
                } catch(e) { resetData(); }
            }
        }

        function saveState() { localStorage.setItem(DB_KEY, JSON.stringify(state)); }
        function resetData() { localStorage.removeItem(DB_KEY); location.reload(); }
        function toggleSettings() { document.getElementById('settings-panel').classList.toggle('open'); }

        function toggleTheme() {
            state.theme = state.theme === 'light' ? 'dark' : 'light';
            applyTheme(state.theme);
            saveState();
        }

        function applyTheme(t) {
            if(t === 'dark') {
                document.body.classList.add('dark');
                scene.fog = new THREE.FogExp2(0x050505, 0.02);
                scene.background = new THREE.Color(0x050505);
                particles.material.color.setHex(0xffffff);
            } else {
                document.body.classList.remove('dark');
                scene.fog = new THREE.FogExp2(0xeef2f5, 0.02);
                scene.background = new THREE.Color(0xeef2f5);
                particles.material.color.setHex(0x000000);
            }
        }

        function updateProgress() {
            const percent = Math.min(100, Math.round((state.q / questions.length) * 100));
            const circumference = 2 * Math.PI * 50; // radius = 50
            const offset = circumference - (percent / 100) * circumference;
            
            document.getElementById('progress-percent').textContent = percent + '%';
            document.getElementById('progress-fill').style.strokeDashoffset = offset;
        }

        function startQuiz() {
            document.getElementById('progress-container').style.display = 'block';
            switchScreen('screen-intro', 'screen-quiz');
            renderQ();
            updateProgress();
            gsap.to(camera.position, { z: 3.5, duration: 1.5 });
        }

        function resumeQuiz() {
            document.getElementById('progress-container').style.display = 'block';
            document.getElementById('screen-intro').classList.remove('active');
            document.getElementById('screen-intro').style.display = 'none';
            document.getElementById('screen-quiz').classList.add('active');
            document.getElementById('screen-quiz').style.display = 'block';
            renderQ();
            updateProgress();
            camera.position.z = 3.5;
        }

        function switchScreen(a, b) {
            const f = document.getElementById(a);
            const t = document.getElementById(b);
            f.classList.add('exit');
            setTimeout(() => {
                f.classList.remove('active', 'exit');
                f.style.display = 'none';
                t.style.display = 'block';
                void t.offsetWidth; 
                t.classList.add('active');
            }, 500);
        }

        function renderQ() {
            if(state.q >= questions.length) { showResults(); return; }
            const q = questions[state.q];
            const txt = document.getElementById('q-text');
            const grd = document.getElementById('q-options');
            txt.style.opacity = 0; grd.style.opacity = 0;
            setTimeout(() => {
                txt.innerText = q.t;
                grd.innerHTML = '';
                q.o.forEach(o => {
                    const b = document.createElement('div');
                    b.className = 'option-card';
                    b.innerHTML = `<i class="fa-solid ${o.i}"></i><span class="option-text">${o.l}</span>`;
                    b.onclick = () => handle(q.d, o.v);
                    grd.appendChild(b);
                });
                txt.style.opacity = 1; grd.style.opacity = 1;
            }, 300);
        }

        function handle(d, v) {
            if(!state.scores) state.scores = { EI:0, SN:0, TF:0, JP:0 };
            state.scores[d] += v;
            state.q++;
            saveState();
            updateProgress();
            gsap.to(crystal.rotation, { y: crystal.rotation.y + Math.PI, duration: 0.6 });
            renderQ();
        }

        function showResults() {
            document.getElementById('progress-container').style.display = 'none';
            switchScreen('screen-quiz', 'screen-result');
            const s = state.scores;
            const c = (s.EI>=0?'E':'I') + (s.SN>=0?'S':'N') + (s.TF>=0?'T':'F') + (s.JP>=0?'J':'P');
            document.getElementById('res-code').innerText = c;
            document.getElementById('res-name').innerText = archetypes[c];
            document.getElementById('res-desc').innerText = descriptions[c];

            const pct = (v, maxScore) => {
                const normalized = (v / maxScore); 
                return Math.max(0, Math.min(100, 50 + (normalized * 50))); 
            };

            const maxScore = 4;
            const detailBox = document.getElementById('detail-box');
            detailBox.innerHTML = '';

            const createDetail = (label, val, left, right) => {
                const p = pct(val, maxScore);
                const dominant = val >= 0 ? right : left;
                const percent = val >= 0 ? p : 100 - p;
                return `<div class="detail-item"><span class="detail-label">${label}:</span> ${Math.round(percent)}% ${dominant}</div>`;
            };

            detailBox.innerHTML += createDetail("Mind", s.EI, "Introverted", "Extraverted");
            detailBox.innerHTML += createDetail("Energy", s.SN, "Intuitive", "Observant");
            detailBox.innerHTML += createDetail("Nature", s.TF, "Feeling", "Thinking");
            detailBox.innerHTML += createDetail("Tactics", s.JP, "Prospecting", "Judging");

            const percentE = pct(s.EI, maxScore);
            const percentN = pct(s.SN, maxScore);
            const percentT = pct(s.TF, maxScore);
            const percentJ = pct(s.JP, maxScore);

            setTimeout(() => {
                document.getElementById('bar-E').style.height = percentE + '%';
                document.getElementById('bar-N').style.height = percentN + '%';
                document.getElementById('bar-T').style.height = percentT + '%';
                document.getElementById('bar-J').style.height = percentJ + '%';
                
                document.getElementById('pct-E').textContent = Math.round(percentE) + '%';
                document.getElementById('pct-N').textContent = Math.round(percentN) + '%';
                document.getElementById('pct-T').textContent = Math.round(percentT) + '%';
                document.getElementById('pct-J').textContent = Math.round(percentJ) + '%';
            }, 600);
        }
    </script>
</body>
</html>